# 第十五章：服务网格

或许仅次于容器，术语*服务网格*已经成为云原生开发的代名词。然而，就像容器一样，服务网格是一个广义术语，涵盖了各种开源项目以及商业产品。了解服务网格在云原生架构中的一般作用是很有用的。本章将向您展示什么是服务网格，不同的软件项目如何实现它们，以及最后（也是最重要的）在何时将服务网格纳入应用程序，相对于更简单的架构，是有意义的。

###### 注意

在许多抽象的云原生架构图中，似乎服务网格对于云原生架构是必需的。但这在很大程度上并不正确。当考虑采用服务网格时，您必须平衡增加新组件（通常由第三方提供）到依赖列表中所带来的复杂性。在许多情况下，如果现有的 Kubernetes 资源能够满足应用程序的需求，简单依赖这些资源可能更容易和更可靠。

我们之前讨论过 Kubernetes 中的其他网络原语，比如 Services 和 Ingress。鉴于这些网络功能已经存在于 Kubernetes 核心中，为什么还需要向网络层注入额外的功能（以及复杂性）呢？归根结底，这取决于使用这些网络原语的软件应用程序的需求。

Kubernetes 核心中的网络仅意识到应用程序作为目标。Service 和 Ingress 资源都有标签选择器，用于将流量路由到特定的 Pod 集，但除此之外，这些资源在增加附加功能方面相对较少。作为 HTTP 负载均衡器，Ingress 稍微超越了这一点，但是在定义一个适合各种不同现有实现的通用 API 的挑战下，限制了 Ingress API 的功能。如何才能使一个真正的“云原生”HTTP 路由 API 与从裸金属网络设备到未考虑云原生开发的公共云 API 的代理兼容呢？

实际上，服务网格 API 在 Kubernetes 核心之外的发展正是这一挑战的结果。Ingress API 将 HTTP(S)流量从外部世界引入到云原生应用程序中。在 Kubernetes 中的云原生应用程序内部，解放了与现有基础设施兼容的需求，服务网格 API 提供了额外的云原生网络功能。那么这些功能是什么呢？大多数服务网格实现提供了三种一般性能力：网络加密和授权、流量塑形以及可观察性。接下来的部分将依次讨论每一个。

# 使用 Mutual TLS 进行加密和认证

在微服务架构中，Pod 之间网络流量的加密是安全的关键组成部分。由相互传输层安全性提供的加密，即*mTLS*，是服务网格的最流行用例之一。虽然开发人员可以自行实现这种加密，但证书处理和流量加密是复杂且难以正确实现的。将加密的实现留给各个开发团队会导致开发人员忘记完全添加加密，或者实现不当。当加密实施不当时，可能会对可靠性产生负面影响，并且在最坏的情况下根本提供不了真正的安全性。相比之下，在你的 Kubernetes 集群上安装服务网格会自动为集群中每个 Pod 之间的网络流量提供加密。服务网格为每个 Pod 添加了一个旁载容器，该容器透明地拦截所有网络通信。除了保护通信外，mTLS 还使用客户端证书为加密添加了身份，因此你的应用程序安全地知道每个网络客户端的身份。

# 交通整形

当你首次考虑应用程序设计时，通常会有一个清晰的图表，系统中每个微服务或层次都用一个框表示（例如，前端服务，用户偏好服务等）。在实际实施时，实际上通常会有多个实例在应用程序中运行。例如，在从服务版本 X 到版本 Y 的升级过程中，升级的中间阶段会同时运行两个不同版本的服务。虽然升级过程中间是一个临时状态，但是有很多时候你需要创建一个更长时间运行的实验，这种实验会持续一段时间。软件行业常用的模式是“狗粮化”你自己的软件，意思是新版本的软件会在其他地方发布之前先在内部试用。在狗粮化模式中，你可能会在一部分用户中运行服务版本 Y 一天到一周（或更长时间），然后再广泛地发布到所有用户中。

这类实验需要能够进行*交通整形*，即根据请求的特征将请求路由到不同的服务实现。在这个例子中，你可以创建一个实验，使公司内部用户的所有流量都发送到服务 Y，而来自世界其他地方的流量仍然发送到服务 X。

实验在各种场景下都很有用，包括开发中，程序员可以将有限的真实流量（通常为 1%或更少）发送到实验后端，或者可以运行 A/B 实验，其中 50%的用户获得一种体验，另外 50%的用户获得另一种体验，这样你可以建立哪种方法更有效的统计模型。实验是增加应用程序可靠性、灵活性和洞察力的极其有用的方法，但实际中往往难以实现，因此使用率不如可能的高。

服务网格通过将实验集成到网格本身来改变这一点。与其编写代码来实施您的实验，或者在新基础设施上部署应用程序的全新副本，您可以声明性地定义实验的参数（10%的流量发送到版本 Y，90%的流量发送到版本 X），服务网格会为您实现它。尽管作为开发者，您参与定义实验，但实施过程是透明和自动化的，这意味着会运行更多实验，并相应增加可靠性、灵活性和洞察力。

# 自省

如果您像大多数程序员一样，一旦编写了程序，就会在新的错误显现时反复调试它。发现代码中的错误是大多数开发者日常工作的重要部分。当应用程序分布在多个微服务之间时，调试变得更加困难。当一个请求跨越多个 Pod 时，将其组合成一个单一请求是很困难的。调试所需的信息必须从多个源头组合在一起，前提是首先收集到了相关信息。

自动内省是服务网格提供的另一个重要功能。因为它参与了 Pod 之间的所有通信，所以服务网格知道请求被路由到哪里，并且可以跟踪组装完整请求所需的信息。开发者不再看到大量请求发送到多个不同的微服务，而是可以看到一个单一的聚合请求，定义了他们整个应用程序的用户体验。此外，服务网格只需为整个集群实现一次。这意味着无论哪个团队开发了服务，相同的请求跟踪都能正常工作。监控数据在由集群级服务网格连接在一起的所有不同服务之间是完全一致的。

# 您真的需要服务网格吗？

这里描述的优势可能会让你急于在集群上安装服务网格。然而，在你这样做之前，值得考虑一下是否真的需要为你的应用程序安装服务网格。服务网格是一个将复杂性增加到你的应用程序设计中的分布式系统。服务网格深度集成到你的微服务核心通信中。当服务网格失败时，整个应用程序将停止工作。在采用服务网格之前，你必须确信自己能够在问题发生时解决问题。你还必须准备好监控服务网格的软件发布，以确保获取最新的安全性和错误修复，当然，当修复可用时，你也必须准备好在不影响应用程序的情况下部署新版本。这种额外的运营开销意味着对于许多小型应用程序来说，服务网格是一种不必要的复杂性。

如果你正在使用作为托管服务提供的 Kubernetes，它同时提供了服务网格，那么使用该网格会更加容易，因为云提供商将提供支持、调试和无缝的新版本发布服务网格。但即使是由云提供商提供的服务网格，对于开发人员来说也存在额外的学习复杂性。最终，在集群级别，每个应用程序或平台团队都需要权衡服务网格的成本与收益。为了最大化服务网格的好处，对于集群中的所有微服务同时采用它是有帮助的。

# **审视服务网格实现**

云原生生态系统中有许多不同的服务网格项目和实现，但大多数共享许多相同的设计模式和技术。由于服务网格会透明地拦截来自你的应用 Pod 的网络流量，修改并通过集群重新路由它，所以服务网格的一部分需要存在于每个 Pod 中。强制开发人员向每个容器镜像添加某些内容会引入显著的摩擦，同时使得集中管理服务网格版本变得更加困难。因此，大多数服务网格实现在每个网格中的每个 Pod 添加了一个 sidecar 容器。由于 sidecar 位于与应用 Pod 相同的网络堆栈中，它可以使用诸如`iptables`或最近更多使用的`eBPF`等工具来审视和拦截来自你的应用容器的网络流量，并将其处理到服务网格中。

当然，要求每个开发人员在他们的 Pod 定义中添加一个容器镜像几乎和要求他们修改他们的容器镜像一样繁琐。为了解决这个问题，大多数服务网格实现依赖于一个变异接入控制器，以自动向特定集群中创建的所有 Pod 添加服务网格 sidecar。任何用于创建 Pod 的 REST API 请求首先会被路由到这个接入控制器。服务网格接入控制器通过添加 sidecar 来修改 Pod 定义。由于这个接入控制器是由集群管理员安装的，它会透明且一致地为整个集群实现服务网格。

但服务网格不仅仅是修改 Pod 网络。您还需要能够控制服务网格的行为；例如，通过定义用于实验的路由规则或用于网格中服务的访问限制。与 Kubernetes 中的其他所有内容一样，这些资源定义是通过 JSON 或 YAML 对象定义声明性地指定的，您可以使用 `kubectl` 或其他与 Kubernetes API 服务器通信的工具创建它们。服务网格实现利用 *自定义资源定义*（CRD）来向您的 Kubernetes 集群添加专门的资源，这些资源不是默认安装的一部分。在大多数情况下，特定的自定义资源与服务网格本身紧密相关。CNCF 正在进行一个持续的工作，定义一个标准的供应商中立的服务网格接口（SMI），许多不同的服务网格可以实现这个接口。

# 服务网格景观

服务网格景观最令人望而生畏的方面可能是选择哪种网格。到目前为止，没有一种网格被视为事实上的标准。尽管具体的统计数据难以获得，但最受欢迎的服务网格可能是 Istio 项目。除了 Istio，还有许多其他开源网格，包括 Linkerd、Consul Connect、Open Service Mesh 等。还有像 AWS App Mesh 这样的专有网格。我们预计云原生社区在未来几年会继续努力标准化这些接口。

开发人员或集群管理员该如何选择？事实上，最适合您的服务网格很可能是您的云服务提供商为您提供的那种。将服务网格的操作添加到集群操作员已经复杂的职责中通常是不必要的。最好让云服务提供商为您管理它。

如果这对您来说不是一个选项，请进行调查。不要被华丽的演示和功能承诺所吸引。服务网格深深植根于您的基础设施中，任何故障都可能严重影响您应用程序的可用性。此外，由于服务网格的 API 往往是特定实现的，一旦您花费时间围绕它开发应用程序，更改服务网格选择将变得困难。最终，您可能会发现适合您的网格是没有网格。

# 概要

服务网格包含强大的功能，可以为您的应用程序增加安全性和灵活性。同时，服务网格会增加集群操作的复杂性，并可能成为应用程序故障的另一个潜在源头。仔细考虑向基础架构添加服务网格的利弊。如果有选择的余地，请使用托管服务网格，让其他人负责操作细节，同时使您的应用程序能够访问服务网格的功能。

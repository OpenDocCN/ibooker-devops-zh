# 前言

Kubernetes 是否准备好处理有状态工作负载？

自从云计算首次出现以来，数据基础设施（NoSQL/NewSQL、流处理、分析）和应用基础设施（Docker、Kubernetes）迅速成熟，但走的是不同的道路。在我们看来，是时候正式将这两个领域结合起来了。这不是对未来的愿望，而是已经在多个社区间的合作中发生。那些试图管理应用和数据两个独立堆栈的组织，很快会发现自己竞争上的不利处境。

在 Kubernetes 2014 年公开发布后的头几年里，人们很少质疑它是否适合处理数据和有状态工作负载。对流行智慧的一个例子可以在 Kelsey Hightower 2018 年的推特中找到：

> Kubernetes 在能够运行包括数据库和消息队列在内的有状态工作负载方面取得了巨大进展，但我仍然更倾向于不在 Kubernetes 上运行它们。

在过去几年里，潮流已经转变。解决问题的工程师们接受了 Kelsey 的挑战，并将其转化为行动。从某种意义上说，Kubernetes 在处理有状态工作负载方面的成熟是不可避免的，因为需求如此之大。那些能记得关于为何数据库必须在裸金属机器上运行，或者为何不应在容器中部署数据基础设施的争论的人，可以理解这种担忧。

我们也了解到，“从未”和“尚未”之间存在巨大差异。计算、存储、网络现在被视为商品；为什么数据管理不能呢？Kubernetes 的价值主张在于降低成本和简化应用开发，这意味着数据基础设施迁移到 Kubernetes 上是不可避免的。这些变化不仅仅发生在 Kubernetes 上。正如您将看到的，数据基础设施的项目也在发生变化。

# 为什么写这本书

当我们的“日常工作”在 DataStax 挑战我们考虑如何在 Kubernetes 有效地部署和操作 Apache Cassandra 时，我们被卷入将有状态工作负载移至 Kubernetes 的趋势中。在开源开发精神的推动下，我们寻找其他试图用数据库和其他有状态工作负载（并且成功）进行类似尝试的从业者。我们找到了一群志同道合的人，并帮助在 2020 年发起了[Data on Kubernetes Community](https://oreil.ly/WGlmp)（DoKC）。DoKC 现在是一个独立的组织，并举办了 100 多次聚会和数个线下活动。在 DoKC 聚会中的[各种话题和演讲者](https://oreil.ly/b1imM)证明了一个充满活力的社区，共同努力建立标准和最佳实践。更重要的是，我们正在一起学习，应用过去的经验，并在建设新事物时互相支持。

随着我们参与这些聚会，一系列共同的主题开始浮现。我们一次又一次地听到持久卷子系统的优点、StatefulSets 的利弊、运算符模式在使数据库操作更可管理方面的潜力，以及关于新型数据管理想法的早期提示。随着时间的推移，我们坚定地认为这个新兴的从业者社区需要一个地方，来汇集和提炼多个演示和博客文章中散落的智慧，最终形成易于消化的形式。本书就是这一过程的结果。

在云原生数据领域仍有大量工作要做，许多领域需要进一步探索，包括运算符、机器学习、数据 API、数据集的声明式管理等等。我们希望本书能为更多的书籍、博客、演示文稿和学习资源开辟大门。

# 本书适合谁？

本书的主要读者包括在云中设计、构建和运行应用程序的开发人员和架构师。如果您是这样的人，并且正在阅读本书，那么您很可能听说过组织普遍采用 Kubernetes，并且已经加入了这一趋势或至少在考虑中。然而，您可能也听说过关于在 Kubernetes 上运行有状态工作负载的保留意见，并且正在寻找如何解决的帮助。您来对地方了！通过阅读本书，您将获得以下内容：

+   理解基本的 Kubernetes 资源及其如何用于组合数据基础设施

+   欣赏工具如 Helm 和运算符如何自动化部署和操作基于 Kubernetes 的数据基础设施

+   评估和选择数据基础设施技术，以便在您的应用程序中使用。

+   知道如何将这些数据基础设施技术集成到您的整体堆栈中。

+   展望未来几年将增强您基于 Kubernetes 的应用程序的新兴技术视角

还有一个较小但同样重要的受众包括核心 Kubernetes 开发人员和数据基础设施开发人员，其中许多人我们通过 DoKC 认识。我们希望创建一套共同的原则和最佳实践，作为推动 Kubernetes 核心以及在 Kubernetes 中运行的数据基础设施改进的框架。我们可以共同推动在 Kubernetes 上的数据实践前进。

对于每个人来说，了解我们在本书中的目标是直截了当的。在技术成熟和稳定的地方，我们会告诉您，但也有许多技术仍在发展中。我们将确保突出那些需要改进的领域。

# 如何阅读本书

本书的设计是从头到尾阅读，尤其适合那些对 Kubernetes 不太熟悉的读者。前几章介绍了 Kubernetes 的术语和概念，这些术语和概念在后面的书籍中被引用，当我们讨论更高级的主题时，这些术语和概念将显得更为重要。这本书的组织结构如下：

第一章，“云原生数据基础设施简介：持久性、流式处理和批量分析”

本章旨在通过将无状态和有状态工作负载都放在 Kubernetes 上来现代化您的云原生应用。当然，我们会这么说，但您确实应该从这里开始，因为我们定义了关键目标和术语，为所有读者提供了一个平等的基础。具体而言，我们提出了 *云原生数据* 的定义，并定义了云原生数据基础设施的原则，这些原则将贯穿整本书，并用于评估后续技术。

第二章，“在 Kubernetes 上管理数据存储”

在本章中，我们将看一下 Kubernetes 数据基础设施的基础领域之一：存储。我们将从容器化系统中存储是如何工作的开始，从 Docker 开始，然后转向 Kubernetes 及其持久卷子系统。我们将讨论各种可用的存储类型，包括文件、块和对象存储，以及使用本地与远程存储解决方案的权衡。

第三章，“在 Kubernetes 上的数据库的困难之路”

本章介绍了 Kubernetes 计算资源，如 Pod、Deployment 和 StatefulSet，并逐步指导您如何使用这些资源部署 MySQL 和 Apache Cassandra 等数据库。您将了解 StatefulSet 在管理分布式数据库方面的优缺点。

第四章，“使用 Helm 在 Kubernetes 上自动化数据库部署”

继续上一章的主题，我们重新审视了在 Kubernetes 上部署 MySQL 和 Cassandra，这次更加自动化地使用 Helm 软件包管理器。您还将了解 Kubernetes 资源，例如 ConfigMaps 和 Secrets，这些资源有助于配置。我们讨论 Helm 在整体 DevOps 流程和 CI/CD 工具集中的角色，以及在管理数据库操作方面的一些缺点。

第五章，“使用 Operators 在 Kubernetes 上自动化数据库管理”

本章通过介绍操作员模式来结束我们关于数据库部署的序列，并演示操作员如何帮助管理“第二天”的数据库操作。我们将探讨操作员如何扩展 Kubernetes 控制平面以管理数据库，以 Vitess（MySQL）和 Cass Operator（Apache Cassandra）为例。在此过程中，您将学习如何评估操作员的成熟度，甚至如何使用 Operator SDK 等框架构建自己的操作员。

第六章，“在 Kubernetes 栈中集成数据基础设施”

在本章中，我们开始扩展焦点，不仅仅是部署和操作数据库，还考虑如何将数据库和其他数据基础设施整合到您的整体应用堆栈中。我们将查看一个名为 K8ssandra 的项目，该项目集成了 Apache Cassandra 及其管理、安全和数据库备份工具，并提供 API 层以便更轻松地访问数据。

第七章，“Kubernetes 原生数据库”

此时，我们退后一步，总结了书的前半部分关于云原生数据管理的所学，利用这些知识来考虑一个问题：“什么是 Kubernetes 原生数据库？”这不仅仅是关于行业概念的辩论，对于那些参与选择数据基础设施以及开发该基础设施的人来说，这个讨论非常重要。

第八章，“在 Kubernetes 上流式数据”

超越持久性，我们将开始处理其余的数据基础设施，从流处理技术开始。在云原生应用程序中移动和处理数据与数据库持久性同样普遍，但在部署上需要不同的策略：安全连接端点和构建默认的弹性和韧性。在本章中，我们将使用 Apache Pulsar 和 Apache Flink 来展示构建这些重要实践的方式。

第九章，“在 Kubernetes 上的数据分析”

具有讽刺意味的是，大规模分析部署的需求构成了今天 Kubernetes 中许多方法论的起源故事的一部分——即编排和资源管理。环环相扣，如今在许多组织中，在 Kubernetes 中运行分析已成为头等大事。我们重点介绍 Apache Spark 的变化，为您的使用案例提供一个先导，并使用 Dask 和 Ray 项目来研究 Kubernetes 中分析的最前沿。

第十章，“机器学习和其他新兴用例”

AI 和机器学习的主题已经处于基础设施的前沿。在过去几年中启动的项目可能首先在 Kubernetes 上启动，这是一个值得考虑的有趣现象。还有其他类型的项目首先考虑云原生，并为数据的未来提供一些方向性。本章旨在调查这些项目，并广泛提供作为在云原生数据上进行前进时考虑的思想和方法。

第 11 章，“将数据工作负载迁移到 Kubernetes”

如果您不将书中获得的所有知识付诸实践，那么这些知识将毫无用处。在本章中，我们强调了前几章的关键教义，并提出了一个框架，即人员、流程和技术变革，帮助您成功地将有状态的工作负载迁移到 Kubernetes。最后，我们展望了您的组织在不久的将来可能会拥有的数据基础设施的愿景。

在 Kubernetes 上管理数据的学科是一个新兴的学科，特别是在某些领域发生了很多变化。我们承认，像任何技术书籍一样，本书代表了特定时间点上可用知识的一个快照——在本例中为 2022 年末。编写关于快速发展主题的书籍的真正危险在于信息变得多快地变得无关紧要。

为了最好地应对这一现实，本书中应用了一个通用的公式：我们提供了大量示例，但强调基础知识。随着我们深入研究，我们检查的技术变得越来越不成熟。与其寻找复制粘贴答案或一刀切架构，我们鼓励您提取适用于您独特用例的核心原则。

特别是，自从第二章到第五章涉及到已经确立的主题，你将在这些章节中找到更深入的解释和实际示例。第八章到第十章探讨了数据基础设施，这些基础设施在 Kubernetes 上的部署仍在发生较大变化。在这些情况下，我们更频繁地指向第三方学习资源，以确保您拥有最新的体验。本书的初衷是鼓励您与他人分享您发现的新资源，以便我们共同进步。

# 本书中使用的约定

本书中使用的以下印刷约定：

*Italic*

指示新术语、URL、电子邮件地址、文件名和文件扩展名。

`Constant width`

用于程序清单，以及在段落中引用程序元素，例如变量或函数名称、数据库、数据类型、环境变量、语句和关键字。

**`Constant width bold`**

显示用户需按字面输入的命令或其他文本。

*`常量宽度斜体`*

显示应由用户提供的值或由上下文确定的值。

###### 提示

此元素表示提示或建议。

###### 注意

此元素表示一般注释。

###### 警告

此元素指示警告或注意事项。

# 使用代码示例

附加材料（代码示例、练习等）可在[*https://github.com/data-on-k8s-book/examples*](https://github.com/data-on-k8s-book/examples)下载。

如果您有技术问题或在使用代码示例时遇到问题，请发送电子邮件至*bookquestions@oreilly.com*。

本书旨在帮助您完成工作。一般情况下，如果本书提供示例代码，您可以在自己的程序和文档中使用它。除非您复制了大部分代码，否则无需征得我们的许可。例如，编写一个使用本书多个代码块的程序并不需要许可。销售或分发 O’Reilly 书籍中的示例则需要许可。引用本书并引用示例代码来回答问题也无需许可。将本书示例代码的大部分内容合并到您产品的文档中则需要许可。

我们感谢，但通常不要求署名。署名通常包括标题、作者、出版商和 ISBN。例如：“*Managing Cloud Native Data on Kubernetes* by Jeff Carpenter and Patrick McFadin (O’Reilly)。Copyright 2023 Jeffrey Carpenter and Patrick McFadin, 978-1-098-11139-7。”

如果您认为您使用的代码示例超出了合理使用范围或上述许可，欢迎随时与我们联系*permissions@oreilly.com*。

# O’Reilly Online Learning

###### 注意

超过 40 年来，[*O’Reilly Media*](https://oreilly.com)提供技术和业务培训、知识和见解，帮助公司取得成功。

我们独特的专家和创新者网络通过书籍、文章和我们的在线学习平台分享他们的知识和专长。O’Reilly 的在线学习平台为您提供按需访问的实时培训课程、深入学习路径、交互式编码环境以及来自 O’Reilly 和其他 200 多家出版商的大量文本和视频。欲了解更多信息，请访问[*https://oreilly.com*](https://oreilly.com)。

# 如何联系我们

请将关于本书的评论和问题发送至出版商：

+   O’Reilly Media, Inc.

+   1005 Gravenstein Highway North

+   Sebastopol, CA 95472

+   800-998-9938（美国或加拿大）

+   707-829-0515（国际或本地）

+   707-829-0104（传真）

我们为本书建立了一个网页，列出勘误、示例和任何额外信息。您可以访问[*https://oreil.ly/cloud-native-data-Kubernetes*](https://oreil.ly/cloud-native-data-Kubernetes)查看。

发送电子邮件至 *bookquestions@oreilly.com* 提出评论或询问有关本书的技术问题。

关于我们的书籍和课程的新闻和信息，请访问 [*https://oreilly.com*](https://oreilly.com)。

在 LinkedIn 上找到我们：[*https://linkedin.com/company/oreilly-media*](https://linkedin.com/company/oreilly-media)。

在 Twitter 上关注我们：[*https://twitter.com/oreillymedia*](https://twitter.com/oreillymedia)。

在 YouTube 观看我们：[*https://youtube.com/oreillymedia*](https://youtube.com/oreillymedia)。

# 致谢

首先要感谢 Jess Haberman，她从我们第一次交谈就相信这本书的概念，并努力使其实现，以及我们的编辑 Jill Leonard，她的持续鼓励和智慧建议。

本书的一个关键特色是包含基于我们与专业技术人员和实践者的对话而形成的侧边栏。我们尽可能少地进行编辑，让他们的话语自己说话。因此，我们向那些与我们分享他们的时间和见解的人们表示衷心的感谢：Rick Vasquez、Kiran Mova、Maciej Szulik、John Sanda、Deepthi Sigireddi、Umair Mufti、Irfan Ur Rehman、Dongxu (Ed) Huang、Jake Luciani、Jesse Anderson、Josh van Leeuwen、Holden Karau、Dean Wampler、Theofilos Papapanagiotou、Willem Pienaar、Xiaofan Luan、Josh Patterson、Adi Polak 和 Craig McLuckie。

这些专家不仅贡献了他们的话语，还影响了我们研究的方向和我们在这里讨论的技术选择。Deepthi、Jesse、Umair 和 Rick 也兼任本书的技术审阅员。我们还感谢其他技术审阅员的见解：Wei Deng、Ali Ok、Aaron Morton 和 Noah Gift。

Kubernetes 数据社区（DoKC）对这一努力产生了巨大的启发，我们特别感谢 Bart Farrell、Demitrios Brinkmann 和 Melissa Logan，他们将我们与许多其他社区成员联系起来，并为我们的工作给予了支持和鼓励。我们还要特别感谢 Evan Powell，他通过找到 Demetrios 并资助最初的聚会，使 DoKC 得以诞生。那是点燃了许多美好事物的火花。

Sam Ramji 对本书产生了重大影响，不仅撰写了前言，还通过提醒我们“你必须付出努力才能有自己的见解”挑战了我们的思维过程。Sam 总是愿意打电话、介绍或者在喝啤酒时分享想法。

这本书诞生于全球大流行初期，并在不确定、挑战和复苏的季节中得到培育，无论是在全球范围还是个人层面上。我们非常感谢许多朋友和家人在这段时期与我们同行，并提醒我们像“书进展如何？”这样的问题或者仅仅是一个简单的“你好吗？”的力量。

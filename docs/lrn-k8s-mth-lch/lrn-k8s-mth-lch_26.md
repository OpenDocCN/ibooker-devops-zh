# 22 永不结束

在*午餐月*系列书中，传统上以一个名为“永不结束”的章节结束，以强调总有更多东西可以学习。我认为这一点在 Kubernetes 上比任何其他技术都更真实；这本书最终比最初计划的要大 25%，而且我甚至没有提到每个主题。我尽力涵盖了您使用 Kubernetes 时可能认为重要的所有内容，并在本章中，我将突出一些我没有时间涉及的内容，以便您可以继续探索。我还提供了一些关于选择 Kubernetes 平台和社区简介的指导。

## 22.1 按章节进一步阅读

进一步阅读的主要来源是官方 Kubernetes 网站([`kubernetes.io`](https://kubernetes.io))，其中包含文档和指南，以及 API 参考([`kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/`](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/))，其中详细描述了所有资源和它们的规范。这些是填补本书中一些空白的好地方——而且它们也是如果您参加 Kubernetes 认证考试时可以使用的唯一资源。在我规划每一章时，我发现了一些我没有空间包含的主题，如果您想进一步学习，以下是我们跳过的一些内容：

+   第二章介绍了我们在其他所有章节中使用的 YAML 规范，但没有涵盖*Kustomize*。这是一个简化 YAML 规范的工具。您可以有一个基础规范集和一组覆盖规范，它们为不同的环境提供不同的配置。它功能强大但比 Helm 中的完整模板体验简单。

+   第三章介绍了网络和 Service 资源。一个新的扩展名为*Service Topology*，它为您提供了对 Pod 之间负载均衡的更精细控制。您可以指定网络连接应使用与客户端在同一节点上的 Pod，或同一区域中的节点，以减少网络延迟。

+   第四章详细介绍了配置，但跳过了*投影卷*，这是一种将多个 ConfigMaps 和 Secrets 暴露到容器文件系统中的一个目录中的有用方法——如果你希望为需要在一个地方看到所有配置项的应用独立存储配置项，这会很有用。

+   第五章没有涵盖所有平台特定的卷类型，这些是在生产中您真正需要理解的内容。概念是相同的——您创建一个 PVC 并将其绑定到 Pod 上——但底层存储系统有很大差异。例如，Azure Kubernetes Service 支持使用 Azure Files 或 Azure Disks 的卷。文件更容易在节点之间共享，但磁盘提供了更好的性能。

+   第六章展示了 Deployments 和 DaemonSets 的扩展工作原理，运行相同 Pod 规范的多个副本。扩展意味着运行更多的 Pods，它们进入挂起状态，等待调度器分配给节点。您可以使用第十九章中学到的亲和性和反亲和性规则来控制副本的位置。

+   第七章介绍了多容器 Pods。有一种新的类型称为*临时容器*，这对于调试特别有用；它允许您在现有的 Pod 内运行一个临时容器。临时容器共享 Pod 的网络空间，可以共享卷和进程，因此非常适合调查问题，尤其是如果您的应用程序容器使用没有工具如`curl`（它应该有）的最小 Docker 镜像。

+   第八章探讨了使用 StatefulSets 为应用程序创建稳定环境。在某些情况下，您可能希望 Pod 命名一致，而不保证启动顺序，这样 Pod 可以并行启动。规范中的*Pod 管理策略*允许这样做。

+   第九章介绍了部署和回滚，但您还希望了解*Pod 中断预算*（PDBs）。这些是独立的对象，确保保持一定数量的 Pod 可用，这对于集群或部署问题是一个重要的安全控制。PDBs 优先于其他操作，因此您不能排空节点，如果移除其 Pod 会违反 PDB。

+   第十章为您介绍了 Helm，并涵盖了主要功能，但省略了很多内容。Helm 的模板语言支持使用 if 和 else 语句和循环进行控制流。您可以在图表中创建命名模板和段，并多次使用它们，这使得复杂的应用程序设计或部署选项更容易管理。

+   第十一章介绍了 Kubernetes 中的一些 CI/CD 模式，但没有提到*GitOps*，这是一种吸引人的新方法，其中集群监视 Git 存储库以检查应用程序发布。当创建发布时，集群会自动部署它，因此，管理员不需要访问集群进行应用程序管理，集群会自行更新应用程序。Argo CD 是 GitOps 的 CNCF 项目。

+   第十二章涵盖了自我修复应用程序和资源限制，但没有涉及到*服务质量类别*，这是 Kubernetes 根据 Pod 的资源规范提供服务保证的方式。类别包括 BestEffort、Burstable 和 Guaranteed，您应该了解它们的工作原理，因为它们会影响 Pod 驱逐。

+   第十三章向您展示了如何从 Pods 中收集、转发和存储日志条目。这包括在 Pods 中运行的 Kubernetes 组件，如 API 服务器和 DNS 插件，但您还希望收集 kubelet 和容器运行时的日志。如何做到这一点取决于平台，但将日志放入您的集中式日志系统也很重要。

+   第十四章通过快速浏览导出器和客户端库介绍了 Prometheus。Prometheus 的部署很简单，你应该花时间了解*Prometheus Operator*。它是一个生产级别的部署，为 Prometheus 和 Alertmanager 实例以及抓取目标和警报规则添加了自定义资源定义（CRDs）。

+   第十五章以 Nginx 和 Traefik 为例介绍了入口控制器。如果你正在评估选项，你应该将*Contour*添加到你的列表中。它是一个 CNCF 项目，使用 Envoy 作为底层代理——这是一个非常快速且功能丰富的技术。

+   第十六章探讨了大量的安全选项，但没有包括*PodSecurityPolicy*资源，它允许你定义 Pod 在集群运行之前必须遵守的规则。PodSecurityPolicies 使用准入控制器来阻止不符合你定义的策略的 Pod，它们是一种强大的安全控制，但这是一个新特性，并不是每个平台都提供。

+   第十七章关于 RBAC 的内容没有涵盖*服务账户投影*，这是一种 Pod 规范请求带有声明性过期时间和 JWT 受众的定制令牌的方式。如果你只为初始化容器需要令牌，你可以请求一个在初始化后过期的令牌。你还需要了解 Kubernetes API 服务器如何审计请求，GitHub 上有一个名为*audit2rbac*的有用工具，可以从审计日志生成 RBAC 规则。

+   第十八章为你提供了安装和管理自己的多节点集群的体验，但如果你真的打算这样做，还有很多东西需要了解。*Rancher Kubernetes Engine*（RKE）是 Rancher 的一个开源产品，它简化了本地集群的安装和管理。如果你正在考虑混合环境，你可以使用 Azure Arc 等服务在云中管理你的本地集群。

+   第十九章介绍了 HorizontalPodAutoscaler，但还有两种其他类型的自动扩展。*VerticalPodAutoscaler*是 Kubernetes 项目的一个附加组件，它根据实际使用情况管理资源请求和限制，因此 Pod 可以向上或向下扩展，并且集群有一个准确资源视图。*集群自动扩展*监控调度器。如果没有足够的计算资源来运行挂起的 Pod，它将在集群中添加一个新的节点。云提供商通常提供集群自动扩展服务。

+   第二十章遗漏了扩展 Kubernetes 的另一种选择——API*聚合*。CRDs 向标准 API 添加了新的资源类型，但聚合层允许你将全新的功能类型插入到 API 服务器中。它并不常用，但它让你能够向你的集群添加新的功能，这些功能由 Kubernetes 进行认证。

+   第二十一章介绍了许多无服务器平台选项，但还有一种关于无服务器的看法——当没有工作要做时缩小到零。一个名为 *KEDA*（Kubernetes 事件驱动自动扩展）的 CNCF 项目涵盖了这一点。它监控事件源，如消息队列或 Prometheus 指标，并根据传入的负载自动扩展或缩小现有应用程序。如果你想要与现有工作流程的自动管理，这是一个很好的无服务器替代方案。

我还没有提到 Kubernetes 的 *仪表板*。这是一个在集群中运行的 Web UI，它显示你工作负载的图形视图及其健康状况。你还可以使用仪表板部署应用程序和编辑现有资源，所以如果你使用它，你需要注意你的 RBAC 规则以及谁可以访问 UI。

你可以根据自己的需要决定对那些额外主题进行深入挖掘的程度。这些主题没有出现在书中，因为它们不是你 Kubernetes 经验的核心，或者它们使用了尚未得到广泛应用的全新功能。无论你决定走多远，你的下一个真正任务是了解你将使用哪个 Kubernetes 平台。

## 22.2 选择 Kubernetes 平台

Kubernetes 为发行版和托管平台提供了一个认证流程。如果你正在评估一个平台，你应该从认证列表开始，你可以在 CNCF 景观网站上找到这个列表（[`landscape.cncf.io/`](https://landscape.cncf.io/)）。Kubernetes 特别适合云环境，你可以在几分钟内启动一个集群，并且这个集群可以很好地与其他服务提供商的服务集成。至少，你应该期待以下功能集，你将在所有主要云服务中找到这些功能：

+   与负载均衡器服务的集成，这样它们就会与云负载均衡器一起提供，该负载均衡器跨越集群节点和公共 IP 地址

+   多种存储类，例如 SMB 和 SSD，这样你可以在你的 PersistentVolumeClaims 中在 I/O 性能和可用性之间进行选择

+   密钥存储，因此部署到集群中的密钥实际上是在一个安全的加密服务中创建的，但仍然可以通过常规的密钥 API 访问

+   集群自动扩展，这样你可以设置最小和最大集群大小，并根据你的 Pods 规模需求添加或删除节点

+   多种身份验证选项，因此最终用户可以使用他们的云凭证访问集群，但你也可以为自动化系统提供访问权限

如果你的组织与某个提供商有现有关系，你的云提供商选择可能已经被决定了。Azure Kubernetes 服务、Amazon 的 Elastic Kubernetes 服务和 Google Kubernetes Engine 都是很好的选择。如果你确实有选择，你也应该考虑平台推出新 Kubernetes 版本的速度以及服务的管理程度——节点是否完全由平台管理，或者你是否需要推出操作系统补丁？

当你确定了一个托管平台，你需要花一些时间学习云的其他功能是如何与 Kubernetes 集成的。对象元数据中的注释通常用作桥梁，以包含标准 Kubernetes 模型之外的云服务配置设置。这是一种有用的配置部署的方式，以便你得到你想要的确切结果，但你需要意识到任何定制都会降低你应用程序的可移植性。

对于本地部署的情况，情况略有不同。你仍然有认证流程，许多产品提供带有定制管理体验和支持团队的标准 Kubernetes 集群。其他产品将 Kubernetes 包装在自己的工具和模型中——OpenShift 就是以这种方式做的，它使用自己的资源定义进行运行时和网络抽象，甚至使用替代的 CLI。包装后的发行版可能提供你更喜欢于标准 Kubernetes 的功能或流程，只要你知道这不仅仅是一个 Kubernetes，而且可能很难将你的应用程序迁移到另一个平台。

运行自己的开源 Kubernetes 集群绝对是一个选择，这是初创公司或拥有大量数据中心资产的组织的首选。如果你正在考虑这条路线，你需要了解你将要承担多少责任。给你的运维团队每个人都发一本这本书，然后让他们去学习和通过认证 Kubernetes 管理员考试。如果他们仍然热衷于运行集群，那就去做吧，但要注意，他们的角色可能会转变为全职 Kubernetes 管理员。这不仅仅是管理集群，还要跟上 Kubernetes 项目本身的发展。

## 22.3 理解 Kubernetes 的构建方式

Kubernetes 有季度发布计划，因此每三个月就会推出新功能，beta 功能升级为通用可用性，旧功能被弃用。这些都是小版本更新——比如说，从 1.17 升级到 1.18。主版本仍然是 1，而且没有计划在不久的将来跳转到版本 2。项目支持最近的三个小版本，这意味着你应该计划至少每年升级你的集群两次。补丁发布会在出现关键错误或安全问题时进行；例如，1.18.6 版本的发布修复了一个问题，即容器可能会在没有触发驱逐的情况下填满节点的磁盘。

所有发布都在 GitHub 的 `kubernetes/kubernetes` 仓库中，每个发布都附带详尽的变更日志。无论你是运行自己的集群还是使用托管平台，在升级之前，你需要了解发布中有什么内容，因为有时会有破坏性的更改。随着功能通过 alpha 和 beta 阶段，规范中的 API 版本会发生变化，最终旧版本将不再受支持。如果你有使用 `apps/v1beta2` API 版本的 Deployment 规范，你无法从 1.16 版本的 Kubernetes 上部署它们——你需要更改规范以使用 `apps/v1` 版本。

特别兴趣小组（SIGs）拥有 Kubernetes 项目的不同方面，包括发布、技术主题和流程——从身份验证到贡献者体验和 Windows 工作负载的一切。SIGs 是公开的；他们有定期的在线会议，任何人都可以加入，他们有专门的 Slack 频道，并且所有决定都在 GitHub 上有记录。一个技术 SIG 覆盖广泛的领域，并分为子项目，这些子项目负责 Kubernetes 一个组件的设计和交付。总体而言，指导委员会负责项目的治理，委员会成员将当选为期两年的任期。

Kubernetes 的开放结构推动了创新和质量。治理模型确保个别组织不会有不公平的代表性，因此它们不能将路线图引导到适合其产品的方向。最终，Kubernetes 本身由 CNCF 管理员负责，CNCF 被授权促进技术、保护品牌并为社区服务。

## 22.4 加入社区

这个社区包括你和我在内。如果你想了解项目的发展情况，最好的开始方式是加入 Slack，网址是 kubernetes.slack.com（你可以在那里找到我）。每个 SIG 都有自己的频道，因此你可以关注你感兴趣的区域，同时存在一些通用频道，用于发布版本公告、用户和初学者。世界各地都有定期的聚会小组，KubeCon 和 CloudNativeCon 大会分别在欧洲、美洲和亚洲举行。所有的 Kubernetes 代码和文档都是开源的，你可以在 GitHub 上进行贡献。

就这些了。感谢你阅读这本书，希望它帮助你变得对 Kubernetes 舒适和自信。它可能是一项改变职业生涯的技术，我希望你在这里学到的所有东西都能帮助你走上旅程。

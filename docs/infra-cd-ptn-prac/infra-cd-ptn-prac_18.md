# 附录 B. 练习题解答

练习题 1.1

在您的组织中选择一个基础设施脚本或配置。评估它是否遵循 IaC 原则。它是否促进可重复性、使用幂等性、帮助组合性和简化可进化性？

答案：

您可以使用以下步骤来识别您的脚本或配置是否遵循 IaC 原则：

+   *可重复性*—复制并粘贴脚本或配置，与他人分享，并要求他们创建资源，而无需修改或更改配置。

+   *幂等性*—运行脚本几次。它不应该改变您的基础设施。

+   *组合性*—复制配置的一部分，并在其他基础设施资源之上构建它。

+   *可进化性*—向配置中添加一个新的基础设施资源，并验证您是否可以在不影响其他资源的情况下进行更改。

练习题 2.1

以下配置基础设施是使用命令式还是声明式风格？

```
if __name__ == "__main__":
   update_packages()
   read_ssh_keys()
   update_users()
   if enable_secure_configuration:
       update_ip_tables()
```

答案：

代码片段使用配置基础设施的*命令式*风格。它定义了如何以特定顺序逐步配置服务器，而不是声明特定的目标配置。

练习题 2.2

以下哪些更改受益于不可变性的原则？（选择所有适用的选项。）

A) 减少网络以拥有更少的 IP 地址

B) 向关系数据库添加列

C) 向现有的 DNS 条目添加新的 IP 地址

D) 将服务器的软件包更新到向后不兼容的版本

E) 将基础设施资源迁移到另一个区域

答案：

正确答案是 A、D 和 E。每个更改都受益于一组实现更改的新资源。如果您尝试就地更改，可能会意外地关闭现有系统。例如，减少网络以拥有更少的 IP 地址可能会替换使用该网络的任何资源。

将软件包更新到向后不兼容的版本意味着一个损坏的包更新可能会影响服务器处理用户请求的能力。将基础设施资源迁移到另一个区域需要时间。并非所有云服务提供商的区域都支持每种类型的基础设施资源。创建新的资源有助于减轻迁移问题。您可以对答案 B 和 C 进行可变更改，可能不会影响系统。

练习题 3.1

以下 IaC 应用于哪些模块模式？（选择所有适用的选项。）

```
if __name__ == "__main__":
  environment = 'development'
  name = f'{environment}-hello-world'
  cidr_block = '10.0.0.0/16'

  # NetworkModule returns a subnet and network
  network = NetworkModule(name, cidr_block)

  # Tags returns a default list of tags
  tags = TagsModule()

  # ServerModule returns a single server
  server = ServerModule(name, network, tags)
```

A) 工厂

B) 单例

C) 原型

D) 构造器

E) 组合

答案：

基础设施即代码适用于 A、C 和 E。网络模块使用组合模式来组合子网和网络。标签模块使用原型模式来返回状态元数据。服务器模块使用工厂模式根据名称、网络和标签返回单个服务器。

代码不使用单例或构造器模式。它不创建单一的全局资源或内部逻辑来构建特定资源。

练习题 4.1

我们如何通过以下 IaC 更好地解耦数据库对网络的依赖？

```
class Database:
  def __init__(self, name):
    spec = {
      'name': name,
      'settings': {
        'ip_configuration': {
          'private_network': 'default'
        }
      }
    }
```

A) 该方法充分解耦了数据库和网络。

B) 将网络 ID 作为变量传递，而不是将其硬编码为`default`。

C) 为所有网络属性实现并传递一个`NetworkOutput`对象到数据库模块。

D) 向网络模块添加一个函数，将其网络 ID 推送到数据库模块。

E) 向数据库模块添加一个函数来调用`default`网络 ID 的基础设施 API。

答案：

你可以实现适配器模式来输出网络属性（C）。数据库选择它使用的网络属性，例如网络 ID 或 CIDR 块。这种方法最好遵循依赖注入的原则。虽然 D 实现了依赖反转，但它没有实现控制反转。答案 E 实现了依赖注入，但继续硬编码网络 ID。

练习 6.1

你注意到负载均衡器模块的新版本破坏了你的 DNS 配置。一个队友更新了模块，使其输出私有 IP 地址而不是公共 IP 地址。你能做些什么来帮助你的团队更好地记住模块需要公共 IP 地址？

A) 为私有 IP 地址创建一个单独的负载均衡器模块。

B) 添加模块合同测试以验证模块输出私有和公共 IP 地址。

C) 在模块的文档中添加一个备注，说明它需要公共 IP 地址。

D) 在模块上运行集成测试并检查 IP 地址是否公开可访问。

答案：

而不是创建一个新的模块，你可以添加一个合同测试来帮助团队记住高级资源需要私有和公共 IP 地址（B）。你可以创建一个单独的负载均衡器模块（A）。然而，这可能不会帮助你的团队记住特定模块必须输出特定的变量。更新模块的文档（C）意味着你的团队必须记得首先阅读文档。当合同测试足够解决问题时，集成测试运行的时间和财务成本（D）可能不会帮助。

练习 6.2

你添加了一些防火墙规则以允许应用程序访问一个新的队列。对于这个变更，以下哪种测试组合对你的团队最有价值？

A) 单元和集成测试

B) 合同和端到端测试

C) 合同和集成测试

D) 单元和端到端测试

答案：

两个最有价值的测试是单元和端到端测试（D）。单元测试将帮助确保没有人会删除新的规则。端到端测试检查应用程序是否可以成功访问队列。合同测试不会提供任何帮助，因为你不需要测试防火墙规则输入和输出。

练习 7.1

选择您组织中的一个标准基础设施更改。为了自信地持续将更改交付到生产，您需要什么？关于持续部署呢？概述或绘制您的交付管道中的阶段。

答案：

在进行此练习时，请考虑以下问题：

+   您是否有单元测试、集成测试或端到端测试？

+   您使用哪种分支模型？

+   您的公司是否有合规性要求？例如，在生产前必须两人批准更改。

+   当有人需要做出更改时会发生什么？

练习 9.1

考虑以下代码：

```
if __name__ == "__main__":
  network.build()
  queue.build(network)
  server.build(network, queue)
  load_balancer.build(server)
  dns.build(load_balancer)
```

队列依赖于网络。服务器依赖于网络和队列。您将如何运行带有 SSL 升级的蓝绿部署？

答案：

您创建了一个启用 SSL 的`绿色`队列。然后，您创建了一个新的`绿色`服务器，该服务器依赖于队列。测试绿色服务器上的应用程序是否可以使用 SSL 配置访问队列。如果通过，您可以将绿色服务器添加到负载均衡器。通过使用金丝雀部署逐渐将流量发送到绿色服务器，直到您确认所有请求都成功。然后，您移除原始服务器和队列。

可选地，您可以选择省略创建绿色服务器的步骤，并将流量从原始服务器发送到 SSL。然而，这种方法可能无法运行金丝雀部署。您更新服务器的配置以直接与新的队列通信。

练习 10.1

给定以下代码，您会使用什么顺序和资源分组来重构和分解单体应用？

```
if __name__ == "__main__":
  zones = ['us-west1-a', 'us-west1-b', 'us-west1-c']
  project.build()
  network.build(project)
  for zone in zones:
    subnet.build(project, network, zone)
  database.build(project, network)
  for zone in zones:
    server.build(project, network, zone)
  load_balancer.build(project, network)
  dns.build()
```

A) DNS，负载均衡器，服务器，数据库，网络+子网，项目

B) 负载均衡器+DNS，数据库，服务器，网络+子网，项目

C) 项目，网络+子网，服务器，数据库，负载均衡器+DNS

D) 数据库，负载均衡器+DNS，服务器，网络+子网，项目

答案：

减少重构风险的顺序和分组从 DNS 开始，然后是负载均衡器、队列、数据库、服务器、网络和子网，以及项目（A）。您希望从 DNS 作为最高级依赖项开始，并独立于负载均衡器进行演变，因为负载均衡器需要项目和网络属性。以下是对下一组资源的重构：服务器、数据库、网络和项目。

您在数据库之前重构服务器，因为服务器不直接管理数据，而是依赖于数据库。如果您对重构数据库没有信心，至少您已经将服务器从单体应用中移除！您总是可以将数据库、网络和项目留在单体应用中。将大部分资源从单体应用中移除可以充分解耦系统以进行扩展。

练习 11.1

一个团队报告说，它的应用程序无法再连接到另一个应用程序。该应用程序上周工作正常，但自周一以来请求失败。团队没有对其应用程序进行任何更改，并怀疑问题可能是防火墙规则。你可以采取哪些步骤来解决这个问题？（选择所有适用的。）

A) 登录云提供商并检查应用程序的防火墙规则。

B) 将新的基础设施和应用程序部署到绿色环境进行测试。

C) 检查应用程序的 IaC 中的变化。

D) 将云提供商中的防火墙规则与 IaC 进行比较。

E) 编辑防火墙规则，允许应用程序之间的所有流量。

答案：

步骤是 A、C 和 D。你可以通过检查防火墙规则中的任何漂移来进行故障排除。如果没有发现漂移，你可以在运行应用程序的 IaC 中搜索其他差异。从故障排除的角度来看，这个问题可能不需要新的测试环境或允许应用程序之间的所有流量。

练习 12.1

给定以下代码，以下哪些陈述是正确的？（选择所有适用的。）

```
HOURS_IN_MONTH = 730
MONTHLY_BUDGET = 5000
DATABASE_COST_PER_HOUR = 5
NUM_DATABASES = 2
BUFFER = 0.1

def test_monthly_budget_not_exceeded():
   total = HOURS_IN_MONTH * NUM_DATABASES * DATABASE_COST_PER_HOUR
   assert total < MONTHLY_BUDGET + MONTHLY_BUDGET * BUFFER
```

A) 测试将通过，因为数据库的成本在预算内。

B) 测试估计数据库的月度成本。

C) 测试没有考虑不同的数据库类型。

D) 测试计算每个数据库实例的月度成本。

E) 测试包括 10%的成本超支缓冲作为软强制性政策。

答案：

答案是 B、C 和 E。数据库每月的总估计成本为 7,300 美元，而包含 10%缓冲的月度预算为 5,500 美元，这意味着测试失败。测试本身没有考虑不同的数据库类型或计算每个数据库实例的月度成本。它是基于每小时率和数据库数量进行计算的。将 10%的缓冲添加到月度预算中为预算创建了一个软强制性政策。导致轻微成本超支的小变化将减少将产品交付到生产中的摩擦，但会标记任何重大的成本变化。

练习 12.2

假设你有三个服务器。你检查它们的利用率，并注意到以下情况：

+   你需要一个服务器来处理最小流量。

+   你需要三个服务器来处理最大流量。

+   服务器每天 24 小时、每周 7 天都在处理流量。

你下个月可以采取哪些措施来优化服务器的成本？

A) 安排资源在周末停止。

B) 添加`autoscaling_policy`以根据内存进行扩展。

C) 为所有服务器设置三小时的过期时间。

D) 将服务器更改为较小的 CPU 和内存机器类型。

E) 将应用程序迁移到容器中，并在服务器上更密集地打包应用程序。

答案：

您可以添加一个`autoscaling_policy`来根据内存进行扩展（B）。您不能在周末安排资源停止，因为您周末至少需要一个服务器。设置过期时间或缩减服务器规模在这种情况下并不能帮助降低成本。将应用程序迁移到容器涉及一个长期的解决方案，这不会优化下一个月的成本。

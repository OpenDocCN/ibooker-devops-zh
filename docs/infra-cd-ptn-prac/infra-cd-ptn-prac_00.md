# 目录

## 前言

我第一次参观数据中心时，被入口处的视网膜扫描仪、闪烁的灯光、冷却系统和五颜六色的电线深深吸引。由于我的背景是电气工程，我能够欣赏到管理硬件的复杂性。当一家公司聘请我来管理一个私有云平台时，我遇到了令人困惑的云计算概念。我不再插线并构建服务器，而是盯着数千台服务器的用户界面中的进度条，并编写糟糕的脚本来部署它们。

在那时，我意识到我需要学习更多。我想自动化更多的基础设施，并编写其他团队成员可以使用的可持续代码。我的学习之旅反映了云计算和 DevOps 哲学的发展。我们需要学习如何改变和扩展我们的基础设施，以跟上业务创新并避免影响关键系统！随着公共云使得按需获取基础设施资源变得更加容易，我们几乎可以将我们的基础设施视为我们软件的延伸。

我通过成为一名通才经历了坎坷的学习之旅。我评估了公共云迁移的成本，与高级 Java 开发者配对（这个挑战让我流泪），将设计模式和软件开发理论应用于代码，尝试了敏捷方法，并向质量保证和安全专业人士提出了许多问题。当我吸收了不同的观点和技术经验后，我试图作为顾问和开源基础设施工具的开发者倡导者，帮助其他人在他们的学习之旅上。

我决定写这本书，因为足够多的系统管理员、安全专业人士和软件开发者表示，他们想学习基础设施即代码（IaC），并需要一个组织编写 IaC 的模式和实践的资源。这本书反映了我早期关于 IaC 以及应用特定模式和实践的考虑和挑战的所有愿望，不受工具和技术的影响。

我从未预料到这本书会有如此多的细节。每当我发布一个章节时，我都会收到来自某人的关于我忘记的事情或建议将某个主题扩展为一个章节的笔记。许多章节涵盖了有整本书（甚至纪录片）专门讨论的主题，但在这本书中只进行了概括性的、高层次的处理。我专注于你必须知道的最重要的事情，以便将主题应用于 IaC。

您可能会看看这本书中的示例，问：“为什么不使用这个*其他*工具？”我在平衡高级理论和实际示例方面遇到了困难。代码列表引发了我的审稿人和编辑们的热烈讨论，他们中的许多人建议在不同的语言、工具和平台上进行扩展或替换！我尽力找到语言、工具和平台的组合来展示这些模式。在写作时，您会发现代码列表是用 Python 编写的，由 HashiCorp Terraform 部署，并在 Google Cloud Platform (GCP)上运行。每个代码列表都附带了一个高级描述，其中包含了模式和练习，您可以根据需要应用，无论语言、工具或平台。

我希望您阅读这本书，并找到一两个有助于您编写更干净的 IaC、在团队中协作 IaC 以及在公司范围内扩展和保障 IaC 的模式。请不要期望使用每一个模式和练习，或者一次性应用所有这些。您可能会感到不知所措！当您在 IaC 中遇到挑战时，我希望您能回到这本书，参考更多模式。

## 致谢

写一本书需要社区的支持，而帮助我的这个社区是杰出的。

感谢我的伴侣，Adam，他帮助我抽出时间（以及大量的咖啡）来专注于这本书的编写。还要感谢我的家人，他们鼓励我追求我对基础设施的兴趣。即使你们不理解我试图理清的技术概念，你们也提供了鼓励和支持的言语，并倾听我的想法。

我非常感谢 Manning 出版社的编辑们——Chris Philips、Mike Shepard、Tricia Louvar 和 Frances Lefkowitz——他们的耐心、鼓励、指导和建议。感谢你们在草稿非常粗糙的情况下，始终保持一致的反馈和承诺。我还想感谢这本书的生产和推广团队。

感谢阅读我的手稿并抽出时间和精力提供反馈的审稿人：Cosimo Attanasi, David Krief, Deniz Vehbi, Domingo Salazar, Ernesto Cárdenas Cangahuala, George Haines, Gualtiero Testa, Jeffrey Chu, Jeremy Bryan, Joel Clermont, John Guthrie, Lucian Maly, Michael Bright, Ognyan Dimitrov, Peter Schott, Ravi Tamiri, Sean T. Booker, Stanford S. Guillory, Steffen Weitkamp, Steven Oxley, Sylvain Martel, 和 Zorodzayi Mukuya，你们的建议帮助这本书变得更加出色。

感谢 HashiCorp 社区团队，感谢你们提供意见、审查概念并鼓励我写作。你们在技术挑战和偶尔的冒名顶替综合症中激励我继续写作。特别感谢我的同事和技术校对员 Taylor Dolezal，他勇敢地检查了我的代码，并在多个版本中阅读了这本书。

向我合作过的系统管理员、测试人员、产品经理、基础设施工程师、业务分析师、软件开发人员和安全工程师，您可能会在这本书中认出一些我们共同探讨、讨论或辩论的模式和最佳实践。感谢您在基础设施即代码方面教会我一些东西。您是使这一切成为可能的社会群体的一部分。

## 关于本书

我编写了《基础设施即代码，模式和最佳实践》一书，旨在帮助您编写不会影响关键业务系统的 IaC。本书侧重于您作为个人、团队或公司可以在整个基础设施系统中应用的模式和最佳实践。它侧重于可以应用于您的 IaC 的高级模式和最佳实践，同时提供具体的示例来展示实现方法。

### 谁应该阅读这本书？

本书面向任何开始使用云基础设施和 IaC 并希望将其扩展到团队或公司的人（软件开发者、安全工程师、质量保证工程师或基础设施工程师）。您将已经编写了一些 IaC，手动运行它，并在公共云上创建了资源。

然而，您现在面临的是在团队或公司内促进 IaC 协作的挑战。您必须减轻多个团队成员和其他团队进行基础设施更改和请求安全、合规性或功能更新时的摩擦。虽然许多资源在特定工具的背景下介绍 IaC，但本书将您可以应用于各种基础设施用例、工具和系统的模式和最佳实践进行了概括，这些工具和系统将随着时间的推移而发展。

### 本书是如何组织的：路线图

我将本书组织为三个部分，共 13 章。

第一部分介绍了基础设施即代码（IaC）以及作为个人如何编写它。

+   第一章定义了 IaC 及其优势和原则。本章解释了本书包含 Python 示例，由 HashiCorp Terraform 运行，并部署到谷歌云平台（GCP）。我还讨论了您在 IaC 之旅中可能会遇到的工具和用例。

+   第二章深入探讨了不可变性的原则以及如何将现有的基础设施资源迁移到 IaC。它还涵盖了编写干净 IaC 的实践。

+   第三章提供了一些将基础设施资源划分为模块的模式的建议。每个模式都包含一个示例和用例列表。

+   第四章涵盖了如何管理基础设施资源和模块之间的依赖关系，并通过依赖注入和一些常见模式将它们解耦。

第二部分描述了如何作为团队编写和协作 IaC。

+   第五章组织了在不同存储库结构中表达 IaC 以及与团队共享时的实践和考虑因素。

+   第六章提供了基础设施测试策略。它描述了每种测试类型以及如何为 IaC 编写它们。

+   第七章将持续交付应用于 IaC。它涵盖了分支模型的高级视图以及您的团队如何使用它们来更改基础设施。

+   第八章提供了构建安全且符合规定的 IaC 的技术，包括测试和标记。

第三部分涵盖了如何在公司内部管理 IaC。

+   第九章将不可变性应用于基础设施更改，包括蓝绿部署的示例。

+   第十章重构了大量 IaC，以提高其可维护性并减轻对单个代码库中失败更改的冲击范围。

+   第十一章描述了撤销 IaC 和将更改向前推进到系统中的方法。

+   第十二章讨论了使用 IaC 来管理云计算成本。它包括 IaC 成本估算的示例。

+   第十三章通过实践来管理和更新 IaC 工具，从而完成本书。

您会发现本书中许多概念相互关联，如果您之前没有练习过 IaC，按顺序阅读章节可能会有所帮助。否则，您可以选择最适合您在 IaC 实践中面临的挑战的部分。

在阅读特定概念的各个章节之前，您可能首先想阅读第一章或附录 A，以了解如何阅读和运行示例。附录 A 提供了有关示例中相关的库、工具和平台的额外详细信息，而附录 B 提供了练习题的答案。

### 关于代码

由于基础设施配置的冗长，本书中的一些代码列表为了清晰起见，并没有包含整个基础设施定义。第二章到第十二章包含了代码列表，作为其概念的示例。

现有的代码列表使用了 Python 3.9、HashiCorp Terraform 1.0 和 Google Cloud Platform 的组合。附录中包含了有关如何运行示例及其工具和库的更多信息。我对 GitHub 上工具的较小版本更新源代码。

本书包含许多源代码示例，既有编号列表，也有与普通文本混排。在这两种情况下，源代码都使用`固定宽度字体`如这样来格式化，以将其与普通文本区分开来。有时代码也会**`加粗`**以突出显示与章节中先前步骤相比有所更改的代码，例如当新功能添加到现有代码行时。

在许多情况下，原始源代码已被重新格式化；我们添加了换行符并重新调整了缩进，以适应书籍中的可用页面空间。在极少数情况下，即使这样也不够，列表中还包括了行续接标记（➥）。此外，当代码在文本中描述时，源代码中的注释通常已从列表中删除。代码注释伴随任何列表，突出显示重要概念。您可以从本书的 liveBook（在线）版本中获取可执行的代码片段，网址为 [`livebook.manning.com/book/essential-infrastructure-as-code`](https://livebook.manning.com/book/essential-infrastructure-as-code)。完整的源代码可以从 Manning 网站 [`www.manning.com/books/infrastructure-as-code-patterns-and-practices`](https://www.manning.com/books/infrastructure-as-code-patterns-and-practices) 和 GitHub [`github.com/joatmon08/manning-book`](https://github.com/joatmon08/manning-book) 下载。

### liveBook 讨论论坛

购买 *基础设施即代码：模式和最佳实践* 包括免费访问 liveBook，Manning 的在线阅读平台。使用 liveBook 的独家讨论功能，您可以在全球范围内或针对特定部分或段落附加评论。为自己做笔记、提出和回答技术问题以及从作者和其他用户那里获得帮助都非常简单。要访问论坛，请访问 [`livebook.manning.com/book/infrastructure-as-code-patterns-and-practices/discussion`](https://livebook.manning.com/book/infrastructure-as-code-patterns-and-practices/discussion)。您还可以在 [`livebook.manning.com/discussion`](https://livebook.manning.com/discussion) 了解更多关于 Manning 论坛和行为准则的信息。

Manning 对读者的承诺是提供一个场所，让读者之间以及读者与作者之间可以进行有意义的对话。这不是对作者参与特定数量承诺的承诺，作者对论坛的贡献仍然是自愿的（且未付费）。我们建议您尝试向作者提出一些挑战性的问题，以免她的兴趣转移！论坛和以前讨论的存档将从出版社网站提供，直到书籍有售。

### 关于云服务提供商

在决定用于示例的云服务提供商时，我遇到了挑战。虽然亚马逊网络服务（AWS）或微软 Azure（Azure）可能在出版时更为流行，但它们需要创建许多资源。例如，它们的网络需要网络、子网、路由表、网关和安全组，你才能使用它们。相反，我决定使用谷歌云平台（GCP）作为主要的云服务提供商，以简化您需要创建的资源数量。

虽然我在示例中使用 GCP，但概念、流程和指南旨在保持中立，您应该能够将它们适应到其他云服务提供商。对于更喜欢使用 AWS 或 Azure 的读者，每个示例都包含了这两个平台上的等效服务信息。此外，一些示例还包括代码仓库中的等效内容。

在第一章中，您可以了解更多关于我选择使用 GCP 的原因，以及如何将示例适应 Azure 和 AWS。附录 A 中包含了在 GCP 上设置和运行示例的说明，以及针对 Azure 和 AWS 用户的提示。

### 其他在线资源

请参考针对您特定 IaC 工具或基础设施提供商的在线资源。其中许多提供了他们在工具中实现的实践和模式示例。

## 关于作者

![Rosemary Wang 作者照片](img/Rosemary_Wang_Author_Photo.png)

玫瑰玛丽·王致力于弥合基础设施、安全和应用开发之间的技术和文化障碍。作为贡献者、公众演讲者、作家和开源基础设施工具的倡导者，她对解决棘手问题充满热情。当她不在白板上绘制时，玫瑰玛丽在她的笔记本电脑上调试各种基础设施系统，同时给她的室内植物浇水。

## 关于封面插图

《基础设施即代码：模式和实战》的封面图题为“Bayadere”，意为“印度的一位女性印度舞者”，取自雅克·格拉塞·德·圣索沃尔于 1797 年出版的作品集。每一幅插图都是手工精心绘制和着色的。

在那些日子里，人们通过他们的服饰很容易就能识别出他们住在哪里，以及他们的职业或社会地位。曼宁通过基于几个世纪前丰富多样的地区文化的封面设计，庆祝计算机行业的创新和主动性，这些文化通过如这一系列图片这样的收藏品被重新带回生活。
